<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.75" />
    <link rel="shortcut icon" href="./../../style/images/LOGO.jpg" />
    <link rel="stylesheet" type="text/css" href="./../../style/song.css">
    <link rel="stylesheet" type="text/css" href="./../../style/jquery.transposer.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,500,500i,600" rel="stylesheet">
    <script type="text/javascript" src="../jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../jquery/jquery.transposer.js"></script>
    <title>Song</title>
</head>

<body>
    <pre id="songContent">
    <!-- Content will be injected here by script -->
  </pre>

    <script>
        document.addEventListener('DOMContentLoaded', function ()
        {
            const params = new URLSearchParams(window.location.search);
            const songContent = params.get('songContent');
            const targetKey = params.get('targetKey'); // For setlist transposition
            const preElement = document.getElementById('songContent');

            if (songContent && preElement)
            {
                // Decode the content passed in the URL
                let decodedContent = decodeURIComponent(songContent);
                let lines = decodedContent.split('\n');

                // The first non-empty line is assumed to be the key.
                let key = "C"; // Default key
                let title = "Song";
                let contentStartIndex = 0;

                for (let i = 0; i < lines.length; i++)
                {
                    const trimmedLine = lines[i].trim();
                    if (trimmedLine !== '')
                    {
                        // If it's a valid key (A-G, maybe with b or #), use it.
                        if (/^[A-G][b#]?$/.test(trimmedLine))
                        {
                            key = trimmedLine;
                            contentStartIndex = i + 1;
                        } else
                        {
                            // Otherwise, the first non-empty line is the title.
                            title = trimmedLine;
                            contentStartIndex = i; // The content includes the title line
                        }
                        break; // We've found the first piece of info, stop looking.
                    }
                }

                // Join the rest of the lines to form the main content
                preElement.textContent = lines.slice(contentStartIndex).join('\n');

                // Use the setlist key if provided, otherwise use the key from the file content
                const finalKey = targetKey || key;
                preElement.setAttribute('data-key', finalKey);

                document.title = title;

            } else
            {
                console.error("Missing songContent parameter in the URL.");
                preElement.textContent = "Error: Song content not found.";
            }
        });
    </script>
</body>

</html>